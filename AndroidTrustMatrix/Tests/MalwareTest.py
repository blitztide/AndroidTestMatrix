import hashlib
import zipfile
import datetime
import re
import requests
import time
from bs4 import BeautifulSoup
import clamd
import os

import AndroidTrustMatrix.config as Config
from AndroidTrustMatrix.Tests import BaseTest
from AndroidTrustMatrix.util import AndroidXMLDecompress

class MalwareTest(BaseTest):
    """Class for holding and running Market Tests"""
    def __init__(self,db,applist):
        super(MalwareTest,self).__init__(db)
        self.searchapps = applist
        self.availableapps = [] # List of pkg_names
        self.proxies = Config.get_proxy_config()
        self.clamd = clamd.ClamdUnixSocket(path=Config.get_clam_socket())
        self.filename = "/tmp/MATRIX_TEMPFILE.apk"
    
    def Run(self,file):
        """Input is a file, output is a dict of results"""
        # Check filehash
        # Lookup in our own database (if found tag as such)
        # Check ClamAV locally
        # If not found, check VT
        # If not found, upload VT
        # Wait till next time
        # Dict Result {
        # "pkg_name": str
        # "md5sum":str
        # "sha1sum":str
        # "sha256sum":str
        # "isMalware":Boolean
        # "AppDate":DateTime
        # }
        Result = {}
        md5sum = hashlib.md5(file).hexdigest()
        sha1sum = hashlib.sha1(file).hexdigest()
        sha256sum = hashlib.sha256(file).hexdigest()
        Result["md5sum"] = md5sum
        Result["sha1sum"] = sha1sum
        Result["sha256sum"] = sha256sum
        
        size = len(file)

        clamresult = self.CheckClamAV(file)
        detection = self.CheckVT(sha256sum)

        # Upload if Not found on VT and size is low
        vt_size = 524288000
        if detection == None:
            if size < vt_size:
                self.UploadVT(file)
            else:
                print("VT: filesize too large to submit")
        
        filestatus = self.CheckFile(self.filename)
        os.remove(self.filename)
        if not filestatus == None:
            AppDate,pkg_name,version_name = filestatus
        else:
            AppDate = datetime.datetime(1981,1,1,1,1,2)
            pkg_name = "Unknown"
            version_name = "Unknown"

        if clamresult or detection:
            Result["isMalware"] = True
            print(f"Package {pkg_name} detected as Malicious")
        else:
            Result["isMalware"] = False
            print(f"Package {pkg_name} detected as Clean")
        
        Result["pkg_name"] = pkg_name
        Result["AppDate"] = AppDate
        Result["Version_Name"] = version_name
        print(Result)
        return Result

    def CheckVT(self,sha256sum):
        """Checks filehash on VirusTotal, if not seen return None, otherwise return detections"""
        url = f"https://virustotal.com/old-browsers/file/{sha256sum}"
        # Common User agent to hide web scraping
        headers = {
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36"
        }
        response = requests.get(url,proxies=self.proxies,headers=headers)
        if response.status_code == requests.status_codes.codes.ok:
            soup = BeautifulSoup(response.text, 'html.parser')
            detections = soup.find(id="detections")
            total = int(detections.get_text().strip().split("/")[0])
        else:
            print("VT: Unknown")
            return None
        threshold = 3
        if total > threshold:
            return True
        else:
            return False

    def CheckClamAV(self,file):
        """Scans the file locally with ClamAV, returns True for isMalware"""
        print("ClamAV: Scanning File ")
        tempfile = open(self.filename,"wb")
        tempfile.write(file)
        tempfile.close()

        result = self.clamd.scan(self.filename)
        if result[self.filename][0] == "FOUND":
            return True
        else:
            return False
    
    def UploadVT(self,file):
        """Uploads the file to VirusTotal"""
        print("VT: Uploading")
        headers = {
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36",
            "Origin":"https://www.virustotal.com",
            "Referer":"https://www.virustotal.com/old-browsers/"
        }
        response = requests.post("https://www.virustotal.com/old-browsers/", data=file, headers=headers, proxies=self.proxies)
        if response.status_code == 302:
            return True
        else:
            return False

    def CheckFile(self,file):
        """Recieves file, extracts date and package name, returns str and datetimeobj"""
        package_regex = r'<manifest [^>]+package="([A-Za-z0-9\.-]+)"'
        version_regex = r'<manifest [^>]+versionName="([A-Za-z0-9\.-]+)"'

        if not zipfile.is_zipfile(file):
            return None
        
        archive = zipfile.ZipFile(file)
        # Check if AndroidManifest exists
        filelist = archive.namelist()
        if not "AndroidManifest.xml" in filelist:
            return None
        
        AppDate = self.fixdate(archive.getinfo("AndroidManifest.xml").date_time)
        manifestFile = archive.open("AndroidManifest.xml")
        decoder = AndroidXMLDecompress()
        manifest = decoder.decompressXML(manifestFile.read())
        search_package = re.search(package_regex,manifest)
        if search_package == None:
            return None
        search_version = re.search(version_regex,manifest)
        if search_version == None:
            return None
        pkg_name = search_package.group(1)
        version_name = search_version.group(1)
        return AppDate,pkg_name,version_name
            
    
    def fixdate(self,date):
        """Fix date returned by zipfile, return datetime object"""
        # Date is in tuple (Year,Month,Day,Hour,Minute,Second)
        year,month,day,hour,minute,second = date
        # Fix for epoch filetime
        if year == 1980 and month == 0:
            DatetimeObj = datetime.datetime(1980,1,1,0,0,0)
            return DatetimeObj
        DatetimeObj = datetime.datetime(year,month,day,hour,minute,second)
        return DatetimeObj

